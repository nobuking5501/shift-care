#!/usr/bin/env python3
"""
ClaudeHelper Session Save Script
éšœå®³è€…æ–½è¨­å‘ã‘ã‚·ãƒ•ãƒˆç®¡ç†ã‚¢ãƒ—ãƒªé–‹ç™ºå°‚ç”¨ç‰ˆ

Usage:
    python save_session.py --session-name "æ©Ÿèƒ½å_ä½œæ¥­å†…å®¹" --tags "frontend,api,database" --summary "ä½œæ¥­è¦ç´„"
    python save_session.py --checkpoint  # ä¸­é–“ä¿å­˜
    python save_session.py --finalize   # æœ€çµ‚ä¿å­˜ï¼†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
"""

import os
import json
import argparse
from datetime import datetime, timedelta
import hashlib
import time

class SessionSaver:
    def __init__(self):
        self.base_dir = os.path.dirname(os.path.abspath(__file__))
        self.sessions_dir = os.path.join(self.base_dir, "sessions")
        self.metadata_dir = os.path.join(self.sessions_dir, "metadata")
        self.checkpoint_dir = os.path.join(self.base_dir, "checkpoints_backup")
        self.session_tracker_file = os.path.join(self.base_dir, ".session_tracker.json")
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        os.makedirs(self.sessions_dir, exist_ok=True)
        os.makedirs(self.metadata_dir, exist_ok=True)
        os.makedirs(self.checkpoint_dir, exist_ok=True)
        
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½è·¡åˆæœŸåŒ–
        self.init_session_tracker()

    def generate_session_id(self, session_name):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆ"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        hash_suffix = hashlib.md5(session_name.encode()).hexdigest()[:8]
        return f"{timestamp}_{hash_suffix}"

    def save_session(self, session_name, tags=None, summary="", content="", is_checkpoint=False, is_finalize=False):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜"""
        session_id = self.generate_session_id(session_name)
        timestamp = datetime.now()
        
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«å
        session_filename = f"{timestamp.strftime('%Y%m%d')}_{session_name.replace(' ', '_')}.md"
        session_path = os.path.join(self.sessions_dir, session_filename)
        
        # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
        metadata = {
            "session_id": session_id,
            "session_name": session_name,
            "timestamp": timestamp.isoformat(),
            "tags": tags.split(",") if tags else [],
            "summary": summary,
            "type": "checkpoint" if is_checkpoint else "finalize" if is_finalize else "regular",
            "file_path": session_path,
            "project": "shift-care-app",
            "status": "completed" if is_finalize else "in_progress"
        }
        
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…å®¹ä½œæˆ
        session_content = self._create_session_content(metadata, content)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
        with open(session_path, "w", encoding="utf-8") as f:
            f.write(session_content)
        
        # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        metadata_path = os.path.join(self.metadata_dir, f"{session_id}.json")
        with open(metadata_path, "w", encoding="utf-8") as f:
            json.dump(metadata, f, indent=2, ensure_ascii=False)
        
        # ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ/æœ€çµ‚ä¿å­˜ã®å ´åˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
        if is_checkpoint or is_finalize:
            self._create_backup(session_path, session_id, is_finalize)
        
        print(f"âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜å®Œäº†: {session_filename}")
        print(f"ğŸ“ Session ID: {session_id}")
        if tags:
            print(f"ğŸ·ï¸  Tags: {tags}")
        print(f"ğŸ“ Summary: {summary}")
        
        return session_id, session_path

    def _create_session_content(self, metadata, content):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…å®¹ã®Markdownç”Ÿæˆ"""
        template = f"""# {metadata['session_name']}

## ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
- **Session ID**: {metadata['session_id']}
- **ä½œæˆæ—¥æ™‚**: {metadata['timestamp']}
- **ã‚¿ã‚°**: {', '.join(metadata['tags'])}
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: {metadata['status']}
- **ç¨®åˆ¥**: {metadata['type']}

## è¦ç´„
{metadata['summary']}

## ä½œæ¥­å†…å®¹
{content if content else "â€»ã“ã“ã«ä½œæ¥­å†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"}

## æˆæœç‰©
<!-- ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã€ä¿®æ­£ã—ãŸç®‡æ‰€ãªã©ã‚’è¨˜è¼‰ -->

## å­¦ã‚“ã ã“ã¨ãƒ»æ³¨æ„ç‚¹
<!-- æ¬¡å›ã«æ´»ã‹ã™ã¹ãçŸ¥è¦‹ã‚’è¨˜è¼‰ -->

## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
<!-- ç¶šè¡Œã™ã¹ãã‚¿ã‚¹ã‚¯ãŒã‚ã‚Œã°è¨˜è¼‰ -->

---
*Generated by ClaudeHelper-Shift-App v1.0*
"""
        return template

    def _create_backup(self, session_path, session_id, is_finalize):
        """ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ/æœ€çµ‚ä¿å­˜ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ"""
        backup_type = "final" if is_finalize else "checkpoint"
        backup_filename = f"{backup_type}_{session_id}.md"
        backup_path = os.path.join(self.checkpoint_dir, backup_filename)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼
        with open(session_path, "r", encoding="utf-8") as src:
            with open(backup_path, "w", encoding="utf-8") as dst:
                dst.write(src.read())
        
        print(f"ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ: {backup_filename}")

    def init_session_tracker(self):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½è·¡åˆæœŸåŒ–"""
        if not os.path.exists(self.session_tracker_file):
            tracker_data = {
                "current_session": None,
                "start_time": None,
                "last_checkpoint": None,
                "auto_checkpoint_interval": 7200  # 2æ™‚é–“ (ç§’)
            }
            with open(self.session_tracker_file, "w", encoding="utf-8") as f:
                json.dump(tracker_data, f, indent=2, ensure_ascii=False)
    
    def start_session_tracking(self, session_name):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½è·¡é–‹å§‹"""
        tracker_data = self.load_session_tracker()
        tracker_data.update({
            "current_session": session_name,
            "start_time": datetime.now().isoformat(),
            "last_checkpoint": datetime.now().isoformat()
        })
        self.save_session_tracker(tracker_data)
        print(f"â° ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½è·¡é–‹å§‹: {session_name}")
        print(f"ğŸ’¡ è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆé–“éš”: {tracker_data['auto_checkpoint_interval'] // 60}åˆ†")
    
    def check_auto_checkpoint_needed(self):
        """è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯"""
        tracker_data = self.load_session_tracker()
        
        if not tracker_data.get("current_session") or not tracker_data.get("last_checkpoint"):
            return False, None
        
        last_checkpoint = datetime.fromisoformat(tracker_data["last_checkpoint"])
        now = datetime.now()
        elapsed = (now - last_checkpoint).total_seconds()
        interval = tracker_data.get("auto_checkpoint_interval", 7200)
        
        if elapsed >= interval:
            return True, tracker_data["current_session"]
        
        return False, None
    
    def perform_auto_checkpoint(self, session_name):
        """è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå®Ÿè¡Œ"""
        print(f"ğŸ”„ è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå®Ÿè¡Œä¸­: {session_name}")
        
        session_id, _ = self.save_session(
            session_name=f"{session_name}_auto_checkpoint",
            tags="auto-checkpoint,cost-optimization",
            summary=f"2æ™‚é–“çµŒéã«ã‚ˆã‚‹è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ",
            content="â€» ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã®ãŸã‚ã®è‡ªå‹•ä¸­é–“ä¿å­˜",
            is_checkpoint=True
        )
        
        # è¿½è·¡æƒ…å ±æ›´æ–°
        tracker_data = self.load_session_tracker()
        tracker_data["last_checkpoint"] = datetime.now().isoformat()
        self.save_session_tracker(tracker_data)
        
        print(f"âœ… è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå®Œäº† - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœ")
        return session_id
    
    def end_session_tracking(self):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½è·¡çµ‚äº†"""
        tracker_data = self.load_session_tracker()
        if tracker_data.get("current_session"):
            start_time = datetime.fromisoformat(tracker_data["start_time"])
            duration = datetime.now() - start_time
            print(f"â±ï¸  ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“: {duration}")
            
            tracker_data.update({
                "current_session": None,
                "start_time": None,
                "last_checkpoint": None
            })
            self.save_session_tracker(tracker_data)
    
    def load_session_tracker(self):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½è·¡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿"""
        try:
            with open(self.session_tracker_file, "r", encoding="utf-8") as f:
                return json.load(f)
        except (FileNotFoundError, json.JSONDecodeError):
            self.init_session_tracker()
            with open(self.session_tracker_file, "r", encoding="utf-8") as f:
                return json.load(f)
    
    def save_session_tracker(self, data):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½è·¡ãƒ‡ãƒ¼ã‚¿ä¿å­˜"""
        with open(self.session_tracker_file, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=2, ensure_ascii=False)

    def auto_generate_summary(self, content):
        """ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰è‡ªå‹•è¦ç´„ç”Ÿæˆï¼ˆç°¡æ˜“ç‰ˆï¼‰"""
        # å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯Claude APIã‚’ä½¿ç”¨ã—ã¦é«˜å“è³ªãªè¦ç´„ã‚’ç”Ÿæˆ
        lines = content.split('\n')
        key_lines = [line for line in lines if any(keyword in line.lower() 
                    for keyword in ['ä½œæˆ', 'ä¿®æ­£', 'å®Ÿè£…', 'è¿½åŠ ', 'å‰Šé™¤', 'ä¿®æ­£', 'ã‚¨ãƒ©ãƒ¼', 'å®Œäº†'])]
        
        if key_lines:
            return " / ".join(key_lines[:3])
        else:
            return "ä½œæ¥­å†…å®¹ã®è©³ç´°è¨˜éŒ²"

def main():
    parser = argparse.ArgumentParser(description="ClaudeHelper Session Saver for Shift-Care App")
    parser.add_argument("--session-name", help="ã‚»ãƒƒã‚·ãƒ§ãƒ³å")
    parser.add_argument("--tags", help="ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰")
    parser.add_argument("--summary", help="ä½œæ¥­è¦ç´„")
    parser.add_argument("--content", help="è©³ç´°å†…å®¹")
    parser.add_argument("--checkpoint", action="store_true", help="ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆä¿å­˜")
    parser.add_argument("--finalize", action="store_true", help="æœ€çµ‚ä¿å­˜ï¼†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—")
    parser.add_argument("--start-tracking", action="store_true", help="ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½è·¡é–‹å§‹")
    parser.add_argument("--check-auto", action="store_true", help="è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆç¢ºèª")
    parser.add_argument("--end-tracking", action="store_true", help="ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½è·¡çµ‚äº†")
    
    args = parser.parse_args()
    saver = SessionSaver()
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½è·¡æ©Ÿèƒ½
    if args.start_tracking:
        session_name = args.session_name or f"session_{datetime.now().strftime('%Y%m%d_%H%M')}"
        saver.start_session_tracking(session_name)
        return
    
    if args.check_auto:
        needs_checkpoint, session_name = saver.check_auto_checkpoint_needed()
        if needs_checkpoint:
            saver.perform_auto_checkpoint(session_name)
        else:
            print("â° è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã¯ä¸è¦ã§ã™")
        return
    
    if args.end_tracking:
        saver.end_session_tracking()
        return
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
    if args.checkpoint:
        session_name = args.session_name or f"checkpoint_{datetime.now().strftime('%H%M')}"
        summary = args.summary or "ä¸­é–“ä¿å­˜"
        tags = args.tags or "checkpoint"
    elif args.finalize:
        session_name = args.session_name or f"finalize_{datetime.now().strftime('%H%M')}"
        summary = args.summary or "æœ€çµ‚ä¿å­˜"
        tags = args.tags or "finalize"
        saver.end_session_tracking()  # æœ€çµ‚ä¿å­˜æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½è·¡çµ‚äº†
    else:
        session_name = args.session_name or f"session_{datetime.now().strftime('%H%M')}"
        summary = args.summary or "ä½œæ¥­è¨˜éŒ²"
        tags = args.tags or "general"
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜å®Ÿè¡Œ
    saver.save_session(
        session_name=session_name,
        tags=tags,
        summary=summary,
        content=args.content or "",
        is_checkpoint=args.checkpoint,
        is_finalize=args.finalize
    )

if __name__ == "__main__":
    main()